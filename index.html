<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bakong Bridge Tester - Public Access</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            margin: 0; 
            padding: 16px; 
            background: #f8fafc;
        }
        h1 { font-size: 24px; margin: 0 0 8px; color: #1e293b; }
        h2 { font-size: 18px; margin: 16px 0 8px; color: #334155; }
        p { color: #64748b; margin: 0 0 16px; line-height: 1.5; }
        .section { 
            background: #fff; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .section h3 { margin: 0 0 8px; font-size: 16px; color: #1e293b; }
        button { 
            display: inline-block; 
            padding: 10px 16px; 
            margin: 6px 4px 0 0; 
            border: 0; 
            border-radius: 8px; 
            background: #3b82f6; 
            color: #fff; 
            font-weight: 600; 
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background: #2563eb; }
        button.secondary { background: #64748b; }
        button.secondary:hover { background: #475569; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        button.warn { background: #ef4444; }
        button.warn:hover { background: #dc2626; }
        button.small { padding: 6px 12px; font-size: 14px; }
        /* Enforce white text for all buttons */
        button, button.secondary, button.success, button.warn, button.small { color: #ffffff !important; }
        
        code { 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 14px;
        }
        pre { 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 16px; 
            border-radius: 8px; 
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.4;
        }
        .small { font-size: 12px; color: #6b7280; }
        
        input[type="text"], textarea, select { 
            width: 100%; 
            box-sizing: border-box; 
            padding: 12px; 
            border: 1px solid #d1d5db; 
            border-radius: 8px; 
            margin-top: 8px; 
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 14px;
        }
        textarea { min-height: 120px; }
        
        .badge { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 500;
            margin-left: 8px; 
        }
        .badge.available { background: #dcfce7; color: #166534; }
        .badge.unavailable { background: #fee2e2; color: #991b1b; }
        .badge.checking { background: #fef3c7; color: #92400e; }
        
        .method-status { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .method-status:last-child { border-bottom: none; }
        .method-name { font-family: monospace; font-weight: 500; }
        .method-available { color: #059669; }
        .method-unavailable { color: #dc2626; }
        
        .logs { 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { margin-bottom: 4px; }
        .log-info { color: #3b82f6; }
        .log-success { color: #059669; }
        .log-warn { color: #d97706; }
        .log-error { color: #dc2626; }
        
        .warning-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .warning-box h4 { margin: 0 0 8px; color: #92400e; }
        
        .info-box {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .info-box h4 { margin: 0 0 8px; color: #1e40af; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<h1>üöÄ Bakong Bridge Tester</h1>
<p>Public testing tool for validating JavaScript bridge integration with the Bakong mobile app. Test all bridge methods, validate data formats, and simulate various payment scenarios.</p>

<div class="info-box">
    <h4>üåê Public Access</h4>
    <p>This is a publicly accessible version of the Bakong Bridge Tester. You can use this tool to test your service integration before submitting for approval. All bridge methods must work correctly for your service to be accepted.</p>
</div>

<div class="warning-box">
    <h4>‚ö†Ô∏è Important for Service Providers</h4>
    <p>This tool simulates the Bakong app environment. Use it to test your service integration before submitting for approval. All bridge methods must work correctly for your service to be accepted.</p>
</div>

<div class="section">
    <h3>Bridge Availability Status</h3>
    <div style="margin-bottom: 12px;">
        <strong>Bakong Bridge:</strong> <span id="bridgeStatus" class="badge checking">checking‚Ä¶</span>
    </div>
    <div id="methods"></div>
</div>

<div class="section">
    <h3>Payment Input Testing</h3>
    <p class="small">Test the paymentInput() method with Sorya Bus payment data</p>

    <label class="small">Payment Data (JSON)</label>
    <textarea id="paymentPayload" placeholder="Enter payment data JSON here..."></textarea>
    <button id="btnPayment">Trigger paymentInput()</button>
    <button class="secondary small" onclick="validatePaymentData()">üîç Validate Only</button>
</div>

<div class="section">
    <h3>Order Completion Testing</h3>
    <p class="small">Test the orderCompleted() method with order and transaction IDs</p>
    
    <button class="success" id="btnOrderCompleted">‚úÖ Trigger orderCompleted()</button>
    <button class="secondary small" onclick="generateOrderData()">ÔøΩÔøΩ Generate New IDs</button>
</div>

<div class="section">
    <h3>Navigation Testing</h3>
    <p class="small">Test navigation bridge methods</p>
    <button class="secondary" id="btnGoBack">‚¨ÖÔ∏è goBack()</button>
    <button class="warn" id="btnDismiss">‚ùå dismiss()</button>
</div>

<!-- Appearance Controls section -->
<div class="section">
    <h3>Appearance Controls</h3>
    <p class="small">Control title, status bar, and toolbar appearance via bridge</p>

    <label class="small">Set Title</label>
    <input id="titleInput" type="text" placeholder="Enter title (e.g., My Service Page)" />
    <button class="small" id="btnSetTitle">setTitle()</button>

    <div style="height: 8px"></div>

    <label class="small">Status Bar Background Color (hex or CSS color)</label>
    <input id="statusBgInput" type="text" placeholder="#121212 or #FFFFFF or rgb(0,0,0)" />
    <button class="small" id="btnSetStatusBarColor">setStatusBarColor(background)</button>

    <div style="height: 8px"></div>

    <label class="small">Status Bar Icons Mode</label>
    <select id="iconModeSelect">
        <option value="light">Light Icons (for dark background)</option>
        <option value="dark">Dark Icons (for light background)</option>
    </select>
    <button class="small" id="btnSetIconMode">setStatusBarIconColor(isLight)</button>

    <div style="height: 8px"></div>

    <label class="small">Set Background & Icons Together</label>
    <button class="small" id="btnSetStatusBarBoth">setStatusBarColor(background, color)</button>

    <div style="height: 8px"></div>

    <label class="small">Toolbar Visibility</label>
    <button class="small success" id="btnShowToolbar">Show Toolbar</button>
    <button class="small warn" id="btnHideToolbar">Hide Toolbar</button>
</div>

<div class="section">
    <h3>Test Results & Logs</h3>
    <div id="logs" class="logs">
        <div class="log-entry log-info">Bridge tester initialized</div>
    </div>
    <button class="small secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    <button class="small" onclick="exportLogs()">üì• Export Logs</button>
</div>

<div class="section">
    <h3>Implementation Examples</h3>
    <p class="small">Copy this code snippet to implement in your service:</p>

    <h4>Payment Input Implementation</h4>
    <pre><code>// Always check if bridge is available before calling
if (window.Bakong && typeof window.Bakong.paymentInput === 'function') {
    const paymentData = {
        amount: "54000",
        currencyCode: "116",
        currencyName: "KHR",
        description: "Book tickets",
        merchantName: "Sorya Bus",
        receiverAccountId: "soyabus@devb",
        receiverName: "Phich Leng",
        orderId: "000001474"
    };
    window.Bakong.paymentInput(JSON.stringify(paymentData));
} else {
    console.error('Bakong bridge not available');
}</code></pre>
</div>

<div class="section">
    <h3>üì± How to Use</h3>
    <p class="small">Follow these steps to test your Bakong integration:</p>
    <ol style="color: #64748b; line-height: 1.6;">
        <li><strong>Open in Bakong App:</strong> Access this page through the Bakong mobile app's webview</li>
        <li><strong>Check Bridge Status:</strong> Verify that the Bakong bridge is available and all methods are detected</li>
        <li><strong>Test Payment Input:</strong> Use the pre-filled Sorya Bus data or modify it for your testing needs</li>
        <li><strong>Test Order Completion:</strong> Trigger the orderCompleted() method with generated order and transaction IDs</li>
        <li><strong>Test Navigation:</strong> Try the goBack() and dismiss() methods</li>
        <li><strong>Test Appearance Controls:</strong> Modify the title, status bar, and toolbar settings</li>
        <li><strong>Monitor Logs:</strong> Check the logs section for detailed information about each test</li>
    </ol>
</div>

<div class="section">
    <h3>üîó Integration Guide</h3>
    <p class="small">For detailed integration instructions, visit the official Bakong documentation or contact the Bakong team for support.</p>
    <p class="small"><strong>Note:</strong> This tool is for testing purposes only. Ensure your production implementation follows all security best practices and Bakong guidelines.</p>
</div>

<script>
    // Default payment data for Sorya Bus
    const defaultPaymentData = {
        amount: "54000",
        currencyCode: "116",
        currencyName: "KHR",
        description: "Book tickets",
        merchantName: "Sorya Bus",
        receiverAccountId: "soyabus@devb",
        receiverName: "Phich Leng",
        orderId: "000001474"
    };

    // Order completion data
    let orderData = {
        orderId: "order_" + Date.now(),
        transactionId: "txn_" + Date.now()
    };

    // Utility functions
    function hasBridge() {
        return typeof window.Bakong === 'object' && window.Bakong !== null;
    }

    function hasMethod(name) {
        return hasBridge() && typeof window.Bakong[name] === 'function';
    }

    function generateRandomHash() {
        const chars = "abcdef0123456789";
        return Array.from({length: 64}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;

        const icon = {
            info: '‚ÑπÔ∏è',
            success: '‚úÖ',
            warn: '‚ö†Ô∏è',
            error: '‚ùå'
        }[type] || '‚ÑπÔ∏è';

        logEntry.textContent = `[${timestamp}] ${icon} ${message}`;

        const logs = document.getElementById('logs');
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
    }

    function updateBridgeStatus() {
        const statusEl = document.getElementById('bridgeStatus');
        const methodsEl = document.getElementById('methods');

        if (hasBridge()) {
            statusEl.textContent = 'Available';
            statusEl.className = 'badge available';
            log('Bakong bridge detected successfully', 'success');
        } else {
            statusEl.textContent = 'Not Available';
            statusEl.className = 'badge unavailable';
            log('Bakong bridge not detected - This is normal when viewing in a regular browser', 'warn');
        }

        // Check individual methods
        const methods = ['paymentInput', 'orderCompleted', 'goBack', 'dismiss', 'setTitle', 'setStatusBarIconColor', 'setStatusBarColor', 'setToolbarVisible'];
        methodsEl.innerHTML = '';

        methods.forEach(method => {
            const div = document.createElement('div');
            div.className = 'method-status';

            const available = hasMethod(method);
            div.innerHTML = `
                <span class="method-name">${method}()</span>
                <span class="${available ? 'method-available' : 'method-unavailable'}">
                    ${available ? '‚úÖ Available' : '‚ùå Missing'}
                </span>
            `;
            methodsEl.appendChild(div);
        });
    }

    function generateOrderData() {
        orderData = {
            orderId: "order_" + Date.now(),
            transactionId: "txn_" + Date.now()
        };
        log(`üîÑ Generated new order data: ${JSON.stringify(orderData)}`, 'info');
    }

    function validatePaymentData() {
        try {
            const rawData = document.getElementById('paymentPayload').value;
            const data = JSON.parse(rawData);

            const required = ['amount', 'currencyCode', 'currencyName', 'description', 'merchantName', 'receiverAccountId', 'receiverName', 'orderId'];
            const missing = required.filter(field => !data[field] || data[field].toString().trim() === '');

            if (missing.length === 0) {
                log('‚úÖ Payment data validation passed', 'success');
                alert('‚úÖ Validation Passed\n\nAll required fields are present and valid.');
            } else {
                log(`‚ùå Payment data validation failed: missing ${missing.join(', ')}`, 'error');
                alert(`‚ùå Validation Failed\n\nMissing required fields:\n${missing.join(', ')}`);
            }
        } catch (e) {
            log(`‚ùå Invalid JSON in payment data: ${e.message}`, 'error');
            alert(`‚ùå Invalid JSON\n\n${e.message}`);
        }
    }

    function clearLogs() {
        document.getElementById('logs').innerHTML = '<div class="log-entry log-info">Ô∏è Logs cleared</div>';
    }

    function exportLogs() {
        const logs = document.getElementById('logs').textContent;
        const blob = new Blob([logs], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bakong-bridge-test-logs-${new Date().toISOString()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        log('üì• Logs exported successfully', 'success');
    }

    // Bridge helper functions
    function callSetTitle() {
        const title = document.getElementById('titleInput').value.trim();
        if (!hasMethod('setTitle')) {
            log('‚ùå setTitle() method not available', 'error');
            alert('‚ùå Bridge Error\n\nsetTitle() method is not available');
            return;
        }
        try {
            window.Bakong.setTitle(title || '');
            log(`üìù Called setTitle('${title}')`, 'success');
        } catch (e) {
            log(`‚ùå Error calling setTitle(): ${e.message}`, 'error');
        }
    }

    function callSetStatusBarColorOnly() {
        const bg = document.getElementById('statusBgInput').value.trim();
        if (!hasMethod('setStatusBarColor')) {
            log('‚ùå setStatusBarColor() method not available', 'error');
            alert('‚ùå Bridge Error\n\nsetStatusBarColor() method is not available');
            return;
        }
        try {
            window.Bakong.setStatusBarColor(bg || '#121212');
            log(`üé® Called setStatusBarColor('${bg || '#121212'}')`, 'success');
        } catch (e) {
            log(`‚ùå Error calling setStatusBarColor(background): ${e.message}`, 'error');
        }
    }

    function callSetIconModeOnly() {
        const mode = document.getElementById('iconModeSelect').value;
        const isLight = mode === 'light';
        if (!hasMethod('setStatusBarIconColor')) {
            log('‚ùå setStatusBarIconColor() method not available', 'error');
            alert('‚ùå Bridge Error\n\nsetStatusBarIconColor() method is not available');
            return;
        }
        try {
            window.Bakong.setStatusBarIconColor(isLight);
            log(`üåì Called setStatusBarIconColor(${isLight})`, 'success');
        } catch (e) {
            log(`‚ùå Error calling setStatusBarIconColor(): ${e.message}`, 'error');
        }
    }

    function callSetStatusBarBoth() {
        const bg = document.getElementById('statusBgInput').value.trim() || '#121212';
        const mode = document.getElementById('iconModeSelect').value; // 'light' | 'dark'
        if (!hasMethod('setStatusBarColor')) {
            log('‚ùå setStatusBarColor(background, color) method not available', 'error');
            alert('‚ùå Bridge Error\n\nsetStatusBarColor(background, color) method is not available');
            return;
        }
        try {
            window.Bakong.setStatusBarColor(bg, mode);
            log(`üéØ Called setStatusBarColor('${bg}', '${mode}')`, 'success');
        } catch (e) {
            log(`‚ùå Error calling setStatusBarColor(background, color): ${e.message}`, 'error');
        }
    }

    function callSetToolbarVisible(visible) {
        if (!hasMethod('setToolbarVisible')) {
            log('‚ùå setToolbarVisible() method not available', 'error');
            alert('‚ùå Bridge Error\n\nsetToolbarVisible() method is not available');
            return;
        }
        try {
            window.Bakong.setToolbarVisible(visible);
            log(`üì± Called setToolbarVisible(${visible})`, 'success');
        } catch (e) {
            log(`‚ùå Error calling setToolbarVisible(): ${e.message}`, 'error');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateBridgeStatus();
        setTimeout(updateBridgeStatus, 1000); // Recheck after 1 second

        // Load default payment data
        document.getElementById('paymentPayload').value = JSON.stringify(defaultPaymentData, null, 2);

        // Set up event listeners
        document.getElementById('btnPayment').addEventListener('click', function() {
            if (!hasMethod('paymentInput')) {
                log('‚ùå paymentInput() method not available', 'error');
                alert('‚ùå Bridge Error\n\npaymentInput() method is not available');
                return;
            }

            try {
                const rawData = document.getElementById('paymentPayload').value;
                const data = JSON.parse(rawData);
                window.Bakong.paymentInput(JSON.stringify(data));
                log('üì§ Called paymentInput() successfully', 'success');
            } catch (e) {
                log(`‚ùå Error calling paymentInput(): ${e.message}`, 'error');
                alert(`‚ùå Error\n\n${e.message}`);
            }
        });

        document.getElementById('btnOrderCompleted').addEventListener('click', function() {
            if (!hasMethod('orderCompleted')) {
                log('‚ùå orderCompleted() method not available', 'error');
                alert('‚ùå Bridge Error\n\norderCompleted() method is not available');
                return;
            }

            try {
                window.Bakong.orderCompleted(JSON.stringify(orderData));
                log(`üì§ Called orderCompleted() with data: ${JSON.stringify(orderData)}`, 'success');
            } catch (e) {
                log(`‚ùå Error calling orderCompleted(): ${e.message}`, 'error');
                alert(`‚ùå Error\n\n${e.message}`);
            }
        });

        document.getElementById('btnGoBack').addEventListener('click', function() {
            if (!hasMethod('goBack')) {
                log('‚ùå goBack() method not available', 'error');
                alert('‚ùå Bridge Error\n\ngoBack() method is not available');
                return;
            }

            window.Bakong.goBack();
            log('üì§ Called goBack() successfully', 'success');
        });

        document.getElementById('btnDismiss').addEventListener('click', function() {
            if (!hasMethod('dismiss')) {
                log('‚ùå dismiss() method not available', 'error');
                alert('‚ùå Bridge Error\n\ndismiss() method is not available');
                return;
            }

            window.Bakong.dismiss();
            log('üì§ Called dismiss() successfully', 'success');
        });

        // Appearance controls event listeners
        document.getElementById('btnSetTitle').addEventListener('click', callSetTitle);
        document.getElementById('btnSetStatusBarColor').addEventListener('click', callSetStatusBarColorOnly);
        document.getElementById('btnSetIconMode').addEventListener('click', callSetIconModeOnly);
        document.getElementById('btnSetStatusBarBoth').addEventListener('click', callSetStatusBarBoth);
        document.getElementById('btnShowToolbar').addEventListener('click', () => callSetToolbarVisible(true));
        document.getElementById('btnHideToolbar').addEventListener('click', () => callSetToolbarVisible(false));

        // Listen for payment completion events
        window.addEventListener('PaymentCompleted', function(event) {
            try {
                const detail = event && event.detail ? event.detail : '';
                const parsed = detail ? JSON.parse(detail) : detail;
                log('üì• PaymentCompleted event received', 'success');
                console.log('PaymentCompleted received:', parsed);
                alert(`üì• Payment Event Received\n\n${JSON.stringify(parsed || detail, null, 2)}`);
            } catch (e) {
                log(`‚ùå Error parsing PaymentCompleted event: ${e.message}`, 'error');
                alert(`üì• Payment Event Received (raw)\n\n${event && event.detail}`);
            }
        });

        log('üöÄ Bridge tester fully initialized and ready', 'success');
    });
</script>
</body>
</html>
